# Railbus

Do you want to use autogenerated set of Rails application routes in your JavaScript files?

Do you want to make requests to your routes from JS with human-readable names like `create_news`, `update_message`?

Here comes Railbus to you.

## Installation

Add this line to your application's Gemfile:

```ruby
gem 'railbus'
```

And then execute:

    $ bundle install

Or install it yourself as:

    $ gem install railbus

You may call this to generate example file and install JavaScript dependencies:

    $ rails g railbus:install

Or do it manually:

1. Run `yarn add @crosspath/yambus`.
2. Create `*.js.erb` file in `app/javascript` (e.g. `lib/routes.js.erb`)
   to use it with Webpack:

```erb
/* rails-erb-loader-dependencies ../config/routes */
<%= Railbus.generate %>
```

And the last step, require this file in your `.js` files where you want to use application routes.

```js
import Routes from 'lib/routes'
```

## Usage

In short:

1. See output of `rails routes`, it includes route names. You may use these names in JS as functions for XHR requests.
2. Append `_path` to a route name to get its URL.

Route names in JS depend on route names in Rails:

Action name | HTTP method | Request function       | Path function
------------|-------------|------------------------|----------------------------
index       | GET         | {plural_name}          | {plural_name}_path
show        | GET         | {singular_name}        | {singular_name}_path
new         | GET         | new_{singular_name}    | new_{singular_name}_path
edit        | GET         | edit_{singular_name}   | edit_{singular_name}_path
create      | POST        | create_{singular_name} | create_{singular_name}_path
update      | PUT/PATCH   | update_{singular_name} | update_{singular_name}_path
destroy     | DELETE      | delete_{singular_name} | delete_{singular_name}_path

### Functions' arguments

Here `String or Number, ...` represents values used in paths, e.g.
`:id`, `:category_id` (zero, one or more params).

And `...path_params` means hash-like object with values for paths, e.g.
`{id: 123, category_id: 56}` (zero, one or more params).

`data` means request body (payload), it can be hash-like object, `FormData` and so on, its allowed types depend on XHR library or request function.

All arguments are optional.

```js
// Request `index`, `show`, `new`, `edit`, `destroy` actions.
({format: String, ...path_params, ...url_options})
// Or:
(String or Number, ..., {format: String, ...url_options})

// Request `create` and `update` actions.
({format: String, ...path_params, ...url_options}, data)
// Or:
(String or Number, ..., {format: String, ...url_options}, data)

// Get path for any action (does not include query string starting with '?').
({format: String, ...path_params})
// Or:
(String or Number, ..., {format: String})
```

### Configuration

By default Railbus generates functions for all routes defined
in `Rails.application` and these functions use `axios`. You may change it:

```js
<%=
  Railbus.generate(
    # Here `YourApp::Engine` inherits `Rails::Engine`.
    # Default: `Rails.application`.
    app:    YourApp::Engine,

    # 'axios' or the name of function defined or imported in this file.
    # Default: 'axios'.
    client: 'request_api',

    # Include only these route paths that start with '/api'.
    # Empty array: include all routes (default).
    include: [%r{^/api}],

    # Exclude all route paths matching regexpes.
    # Empty array: do not exclude any routes (default).
    exclude: [/edit|new/]
  )
%>

import axios from 'axios';
const axios_api = axios.create({
  baseURL: `${document.location.origin}/api/`
})

function request_api(route, params) {
  return axios_api.request({
    url:    params.path,
    method: route.verb,
    params: params.url_options,
    data:   params.data
  })
}
```

### Examples

Let's take these routes as an example:

```ruby
resources :news do
  resources :images, only: %w[index show create update destroy]
end
resources :messages, only: %w[new create]
namespace :my do
  resources :favourites, only: %w[index show create update destroy]
end
```

To make XHR requests with promises you may do this in JS
([axios](https://github.com/axios/axios) required):

```js
import Routes from 'lib/routes'

// Request all favourites and print to console. Note: using namespace `my`.
// It will call `My::FavouritesController#index`.
// Path: '/my/favourites'.
Routes.my_favourites().then(response => console.log(response.data))

// Request all news and print to console.
// String `index` appended to distinguish `index` and `show` actions.
// It will call `NewsController#index`.
// Path: '/news'.
Routes.news_index().then(response => console.log(response.data))

// Request all news filtered by date, and print to console.
// `NewsController#index` with param `date` in query string (GET).
// Path: '/news' with query string '?date=2020-12-31'.
Routes.news_index({date: '2020-12-31'}).then(response => console.log(response.data))

// Request one news and print to console.
// `NewsController#show` with param `id` = 327 (GET).
// Path: '/news/327'.
Routes.news(327).then(response => console.log(response.data))
// Or
Routes.news({id: 327}).then(response => console.log(response.data))

// Specify format (for example, '.json').
// `NewsController#show` with param `id` = 327 (GET) and `format` = 'json'.
// Path: '/news/327.json'.
Routes.news(327, {format: 'json'}).then(response => console.log(response.data))
// Or
Routes.news({id: 327, format: 'json'}).then(response => console.log(response.data))

// Create news with given title.
// `NewsController#create` with param `title` (POST).
Routes.create_news({title: 'Bears showed up in Tomsk'}).then(response => console.log(response.data))

// Create message with given title. Note: `message`, singular form.
// `MessagesController#create` with params `body`, `to` (POST).
Routes.create_message({body: 'Fantastic!', to: 23}).then(response => console.log(response.data))

// Create message with given title. Note: using namespace `my`.
// `My::FavouritesController#create` with param `url` (POST).
Routes.create_my_favourite({url: 'https://best.site'}).then(response => console.log(response.data))

// Attach an image to the news.
// `ImageController#create` with param `news_id` = 41 (GET), `blob` (POST).
Routes.create_news_image(41, {blob: file})

// Get URL for `create` action.
Routes.create_my_favourite_path() // => 'my/favourites'
```

## Development

After checking out the repo, run `bin/setup` to install dependencies. Then, run `rake spec` to run the tests. You can also run `bin/console` for an interactive prompt that will allow you to experiment.

To install this gem onto your local machine, run `bundle exec rake install`.

TODO:

- Support [fetch](https://developer.mozilla.org/ru/docs/Web/API/Fetch_API/Using_Fetch)
- Tests

## Contributing

Bug reports and pull requests are welcome on GitHub at [github.com/crosspath/railbus](https://github.com/crosspath/railbus).

Please do not change version number in pull requests.

## Alternative solutions

1. [rswag](https://github.com/rswag/rswag) +
  [swagger-js](https://github.com/swagger-api/swagger-js) +
  your integration specs (tests)
2. [railsware/js-routes](https://github.com/railsware/js-routes)
3. [mtrpcic/js-routes](https://github.com/mtrpcic/js-routes)
4. [less-js-routes](https://github.com/stevenbristol/less-js-routes)
5. [js_named_routes](https://github.com/jsierles/js_named_routes)

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).
